<section class="space-y-6">
  <header class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-xs text-gray-500">Dashboard</p>
      <h1 class="text-2xl font-semibold title-font">Statistiques du questionnaire</h1>
    </div>

    <div
      class="inline-flex items-center gap-2 rounded-full border px-3 py-2 text-sm font-semibold"
      [ngClass]="{
        'border-green-200 text-green-700 bg-green-50': status() === 'live',
        'border-yellow-200 text-yellow-700 bg-yellow-50': status() === 'loading',
        'border-red-200 text-red-700 bg-red-50': status() === 'error'
      }"
    >
      <span
        class="h-2.5 w-2.5 rounded-full"
        [ngClass]="{
          'bg-green-500': status() === 'live',
          'bg-yellow-400': status() === 'loading',
          'bg-red-500': status() === 'error'
        }"
      ></span>
      <span>
        {{
          status() === 'live'
            ? 'En temps réel'
            : status() === 'error'
              ? 'Hors ligne'
              : 'Connexion...'
        }}
      </span>
    </div>
  </header>

  <div *ngIf="errorMessage() as error" class="rounded-md border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
    {{ error }}
  </div>

  <ng-container *ngIf="overview() as data; else waiting">
    <div class="grid gap-4 md:grid-cols-4">
      <div class="rounded-lg border border-gray-200 bg-white p-4">
        <p class="text-xs text-gray-500">Total de réponses</p>
        <p class="mt-2 text-3xl font-bold">{{ data.totalResponses }}</p>
        <p class="text-xs text-gray-500 mt-1" *ngIf="lastUpdated()">Mis a jour: {{ lastUpdated() | date: 'short' }}</p>
      </div>

      <div class="rounded-lg border border-gray-200 bg-white p-4">
        <p class="text-xs text-gray-500">Satisfaction VERA</p>
        <p class="mt-2 text-2xl font-bold">
          {{
            data.scales['satisfaction_vera'].avg !== null
              ? (data.scales['satisfaction_vera'].avg | number: '1.1-1')
              : '-'
          }}
          <span class="text-sm text-gray-500">/5</span>
        </p>
        <div class="mt-3 h-2 rounded-full bg-gray-100">
          <div
            class="h-2 rounded-full bg-emerald-500"
            [style.width.%]="percent(data.scales['satisfaction_vera'].avg || 0, 5)"
          ></div>
        </div>
      </div>

      <div class="rounded-lg border border-gray-200 bg-white p-4">
        <p class="text-xs text-gray-500">Importance de vérification</p>
        <p class="mt-2 text-2xl font-bold">
          {{
            data.scales['verification_info'].avg !== null
              ? (data.scales['verification_info'].avg | number: '1.1-1')
              : '-'
          }}
          <span class="text-sm text-gray-500">/5</span>
        </p>
        <div class="mt-3 h-2 rounded-full bg-gray-100">
          <div
            class="h-2 rounded-full bg-blue-500"
            [style.width.%]="percent(data.scales['verification_info'].avg || 0, 5)"
          ></div>
        </div>
      </div>

      <div class="rounded-lg border border-gray-200 bg-white p-4">
        <p class="text-xs text-gray-500">Danger de la désinformation</p>
        <p class="mt-2 text-2xl font-bold">
          {{
            data.scales['danger_desinformation'].avg !== null
              ? (data.scales['danger_desinformation'].avg | number: '1.1-1')
              : '-'
          }}
          <span class="text-sm text-gray-500">/5</span>
        </p>
        <div class="mt-3 h-2 rounded-full bg-gray-100">
          <div
            class="h-2 rounded-full bg-yellow-500"
            [style.width.%]="percent(data.scales['danger_desinformation'].avg || 0, 5)"
          ></div>
        </div>
      </div>
    </div>

    <div class="grid gap-4 lg:grid-cols-3">
      <div class="rounded-lg border border-gray-200 bg-white p-4 lg:col-span-2">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold title-font">Sondages recueillis (7 derniers jours)</h2>
          </div>
        </div>
        <div class="mt-4 rounded-md border border-dashed border-gray-200 bg-gradient-to-r from-[#fefefe] via-[#f5f5f5] to-white px-3 py-2">
          <div class="grid grid-cols-[auto,1fr] gap-3 items-stretch">
            <div class="text-[10px] text-gray-500 flex h-48 flex-col justify-between">
              <span *ngFor="let tick of submissionTicks()">{{ tick }}</span>
            </div>
            <div class="h-48 w-full">
              <svg
                [attr.viewBox]="'0 0 ' + chartWidth() + ' 120'"
                class="w-full h-full"
                preserveAspectRatio="none"
              >
                <path
                  [attr.d]="submissionArea(chartWidth(), 122)"
                  fill="#C2E4A1"
                  fill-opacity="0.35"
                  stroke="none"
                />
                <path
                  [attr.d]="sparklinePath(submissionValues(), chartWidth(), 122)"
                  fill="none"
                  stroke="#98c87a"
                  stroke-width="2.5"
                  stroke-linejoin="round"
                  stroke-linecap="round"
                />
              </svg>
            </div>
          </div>
          <div
            class="mt-2 grid gap-1 text-[10px] text-gray-500"
            [style.gridTemplateColumns]="'repeat(' + submissionSeries().length + ', minmax(0,1fr))'"
          >
            <span class="text-center" *ngFor="let item of submissionSeries()">{{ item.label }}</span>
          </div>
        </div>
      </div>

      <div class="rounded-lg border border-gray-200 bg-white p-4">
        <h3 class="text-lg font-semibold title-font">Répartition des âges</h3>
        <div class="mt-4 flex flex-col items-center gap-4">
          <div class="donut" [ngStyle]="donutStyle(data.singleChoice['age_tranche'] || [])" aria-hidden="true"></div>
          <div class="space-y-1 text-sm text-gray-700 w-full">
            <div
              class="flex items-center justify-between"
              *ngFor="let item of data.singleChoice['age_tranche']; let i = index"
            >
              <div class="flex items-center gap-2">
                <span
                  class="h-2 w-2 rounded-full"
                  [style.background]="['#0ea5e9','#22c55e','#f59e0b','#6366f1','#ef4444','#14b8a6'][i % 6]"
                ></span>
                <span>{{ item.value }}</span>
              </div>
              <span class="text-xs text-gray-500">
                {{ percent(item.count, columnTotal(data.singleChoice['age_tranche'])) }}%
              </span>
            </div>
            <p *ngIf="!data.singleChoice['age_tranche']?.length" class="text-xs text-gray-500">Pas encore de reponses.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="grid gap-4 lg:grid-cols-4">
      <div class="rounded-lg border border-gray-200 bg-white p-4 lg:col-span-2">
        <h3 class="text-lg font-semibold title-font">Contenu des réseaux sociaux</h3>
        <div class="mt-4 space-y-2">
          <ng-container *ngIf="toEntryList(data.multiChoice['contenu_rs'] || {}) as list">
            <div class="flex flex-wrap items-end justify-around gap-3">
              <div *ngFor="let item of list" class="flex flex-col items-center gap-1">
                <div class="h-20 min-w-[18px] w-5 bg-gray-100 rounded-md flex items-end overflow-hidden">
                  <div
                    class="w-full rounded-t-md"
                    [style.height.%]="multiChoicePercent(item.count)"
                    [style.background]="accent"
                  ></div>
                </div>
                <span class="text-[11px] text-gray-700 text-center leading-tight">{{ item.value }}</span>
                <span class="text-[10px] text-gray-500">{{ multiChoicePercent(item.count) }}%</span>
              </div>
            </div>
            <p *ngIf="!list.length" class="text-xs text-gray-500">Pas encore de reponses.</p>
          </ng-container>
        </div>
      </div>

      <div class="rounded-lg border border-gray-200 bg-white p-4" *ngIf="data.singleChoice['utilisation_vera'] as utilVera">
        <h2 class="text-lg font-semibold mb-3 title-font">Utilisation de VERA</h2>
        <div class="text-5xl font-bold text-gray-900 flex items-center justify-center h-24 mt-7">
          {{ percent(findValueCount(utilVera, 'oui'), columnTotal(utilVera)) }}%
        </div>
      </div>

      <div class="rounded-lg border border-gray-200 bg-white p-4">
        <h2 class="text-lg font-semibold mb-3 title-font">Moyens d'utilisation de VERA</h2>
        <ng-container *ngIf="toEntryList(data.multiChoice['moyen_utilisation_vera'] || {}) as items">
          <div class="flex items-end justify-around gap-3">
            <div *ngFor="let item of items" class="flex flex-col items-center gap-1">
              <div class="h-20 min-w-[18px] w-5 bg-gray-100 rounded-md flex items-end overflow-hidden">
                <div
                  class="w-full rounded-t-md"
                  [style.height.%]="percent(item.count, columnTotal(items))"
                  [style.background]="accent"
                ></div>
              </div>
              <span class="text-[11px] text-gray-700 text-center leading-tight">{{ item.value }}</span>
              <span class="text-[10px] text-gray-500">{{ percent(item.count, columnTotal(items)) }}%</span>
            </div>
          </div>
          <p *ngIf="!items.length" class="text-xs text-gray-500 mt-2">Aucune donnee.</p>
        </ng-container>
      </div>
    </div>

        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      <div class="rounded-lg border border-gray-200 bg-white p-4" *ngIf="data.singleChoice['exposition_croyance_fake'] as croyance">
        <h2 class="text-lg font-semibold mb-3 title-font">Crédulité face aux fake news</h2>
        <div class="mt-4 flex flex-col items-center gap-4">
          <div class="donut" [ngStyle]="donutStyle(croyance)" aria-hidden="true"></div>
          <div class="space-y-1 text-sm text-gray-700 w-full">
            <div
              class="flex items-center justify-between"
              *ngFor="let item of croyance; let i = index"
            >
              <div class="flex items-center gap-2">
                <span
                  class="h-2 w-2 rounded-full"
                  [style.background]="['#0ea5e9','#22c55e','#f59e0b','#6366f1','#ef4444','#14b8a6'][i % 6]"
                ></span>
                <span>{{ item.value }}</span>
              </div>
              <span class="text-xs text-gray-500">
                {{ percent(item.count, columnTotal(croyance)) }}%
              </span>
            </div>
            <p *ngIf="!croyance.length" class="text-xs text-gray-500">Pas encore de reponses.</p>
          </div>
        </div>
      </div>

      <div class="rounded-lg border border-gray-200 bg-white p-4 lg:col-span-2 flex flex-col">
        <h2 class="text-lg font-semibold mb-5 title-font">Moyens de vérification</h2>
        <ng-container *ngIf="toEntryList(data.multiChoice['moyen_verification'] || {}) as items">
          <div class="space-y-3">
            <div *ngFor="let item of items" class="space-y-1">
              <div class="flex items-center gap-2">
                <div class="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div
                    class="h-full rounded-full"
                    [style.width.%]="percent(item.count, columnTotal(items))"
                    [style.background]="accent"
                  ></div>
                </div>
                <span class="w-12 text-xs text-gray-700 text-right">
                  {{ percent(item.count, columnTotal(items)) }}%
                </span>
              </div>
              <div class="text-xs text-gray-700">{{ item.value }}</div>
            </div>
          </div>
          <p *ngIf="!items.length" class="text-xs text-gray-500 mt-2 text-center">Aucune donnee.</p>
        </ng-container>
      </div>
    </div>

    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      <div class="rounded-lg border border-gray-200 bg-white p-4" *ngIf="data.singleChoice['frequence_utilisation_rs'] as freqRs">
        <h2 class="text-lg font-semibold mb-3 title-font">Utilisation des réseaux sociaux</h2>
        <div class="flex items-end justify-around gap-3">
          <div *ngFor="let item of freqRs" class="flex flex-col items-center gap-1">
            <div class="h-20 min-w-[18px] w-5 bg-gray-100 rounded-md flex items-end overflow-hidden">
              <div
                class="w-full rounded-t-md"
                [style.height.%]="percent(item.count, columnTotal(freqRs))"
                [style.background]="accent"
              ></div>
            </div>
            <span class="text-[11px] text-gray-700 text-center leading-tight">{{ item.value }}</span>
            <span class="text-[10px] text-gray-500">{{ percent(item.count, columnTotal(freqRs)) }}%</span>
          </div>
        </div>
      </div>

      <div class="rounded-lg border border-gray-200 bg-white p-4" *ngIf="data.singleChoice['frequence_fake'] as freqFake">
        <h2 class="text-lg font-semibold mb-3 title-font">Fréquence des fake news</h2>
        <div class="flex items-end justify-around gap-3">
          <div *ngFor="let item of freqFake" class="flex flex-col items-center gap-1">
            <div class="h-20 min-w-[18px] w-5 bg-gray-100 rounded-md flex items-end overflow-hidden">
              <div
                class="w-full rounded-t-md"
                [style.height.%]="percent(item.count, columnTotal(freqFake))"
                [style.background]="accent"
              ></div>
            </div>
            <span class="text-[11px] text-gray-700 text-center leading-tight">{{ item.value }}</span>
            <span class="text-[10px] text-gray-500">{{ percent(item.count, columnTotal(freqFake)) }}%</span>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #waiting>
    <div class="rounded-md border border-dashed border-gray-300 bg-gray-50 px-4 py-6 text-center text-sm text-gray-600">
      En attente des statistiques... Le tableau se mettra a jour des que le back repond.
    </div>
  </ng-template>
</section>
